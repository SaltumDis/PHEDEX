<!-- Combo-handled YUI CSS files: --> 
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?2.7.0/build/treeview/assets/skins/sam/treeview.css"> 
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?2.7.0/build/datatable/assets/skins/sam/datatable.css">
<!-- Combo-handled YUI JS files: --> 
<script type="text/javascript" src="http://yui.yahooapis.com/combo?2.7.0/build/yahoo/yahoo-debug.js&2.7.0/build/event/event-debug.js&2.7.0/build/connection/connection-debug.js&2.7.0/build/json/json-debug.js&2.7.0/build/dom/dom-debug.js&2.7.0/build/treeview/treeview-debug.js&2.7.0/build/logger/logger-debug.js"></script>
<script type="text/javascript" src="http://yui.yahooapis.com/combo?2.7.0/build/yahoo-dom-event/yahoo-dom-event.js&2.7.0/build/dragdrop/dragdrop-min.js&2.7.0/build/element/element-min.js&2.7.0/build/datasource/datasource-min.js&2.7.0/build/datatable/datatable-min.js"></script>

<style type="text/css">
.yui-skin-sam .yui-dt-liner { white-space:nowrap; } 
</style>

<html><head><title>Agents</title>

<script type="text/javascript">
function toggleVisible(id) {
    var elem = document.getElementById(id);
    if (elem.style.display=='block') { elem.style.display='none'; }
    else { elem.style.display='block'; }
    return -1;
}
</script>
</head>
<body class="yui-skin-sam">
<div><input id='node_select' type='text'><a href='#' onClick='return agents()'>Submit</a>
<div id='phedex_agents'></div>
<div id="phedex_agents_table" style="display:block;"></div> 

<script type='text/javascript'>

var agent_node=null;

agents=function() {
  var site = document.getElementById('node_select').value;
  agent_node = new PHEDEX.Node.Agents(site);
  agent_node.update();
}

PHEDEX=function() {}
PHEDEX.Node=function(id) {
	this.id = id;
	this.div = document.getElementById(this.id);
	this.children = [];
	this.createHTML=function() {
		var result =         "<div id='"+this.id+"_header'>"
                                +    "<a href='#' onClick='return toggleVisible(\""+this.id+"_table\")'>(+)</a>"
				+    this.header()
				+    "</div>"
				+    "<div id='"+this.id+"_collapse' style='display:none'>"
				+    this.main()
				+    "</div>";
		this.div.innerHTML=result;
		return;
	}
	this.header=function() {
		return '';
	}
	this.main=function() {
		return '';
	}
	this.update=function() {
	  return;		
	}
	this.receive=function(data) {}
}
PHEDEX.Node.Agents=function(site) {
	var that=new PHEDEX.Node('phedex_agents');
	that.site=site;
	that.data = null;
	that.header=function() {
          var now = new Date() / 1000;
          var minDate = now;
          var maxDate = 0;
          for ( var i in this.data['agent']) {
	    var a = this.data['agent'][i];
            var u = a['time_update'];
            a['gmtDate'] = new Date(u*1000).toGMTString();
            if ( u > maxDate ) { maxDate = u; }
            if ( u < minDate ) { minDate = u; }
          }
	  var msg = "Site: "+this.data['node']+", agents: "+this.data['agent'].length;
          if ( maxDate > 0 )
          {
            var minGMT = new Date(minDate*1000).toGMTString();
            var maxGMT = new Date(maxDate*1000).toGMTString();
            var dMin = Math.round(now - minDate);
            var dMax = Math.round(now - maxDate);
            msg += " Update-times range: "+dMin+" - "+dMax+" seconds ago";
          }
          return msg;
	}
	that.main=function() {
          var table = [];
	  for (var i in this.data['agent']) {
	    var a = this.data['agent'][i];
            var y = { Agent:a['name'], Version:a['version'], PID:a['pid'], Date:a['gmtDate'] };
            table.push( y );
          }
          var columnDefs = [
	            {key:"Agent", sortable:true, resizeable:true},
	            {key:"Version", sortable:true, resizeable:true},
	            {key:"PID", sortable:true, resizeable:true},
	            {key:"Date", formatter:YAHOO.widget.DataTable.formatDate, sortable:true, resizeable:true},
	        ];
          var dataSource = new YAHOO.util.DataSource(table);
	        dataSource.responseType = YAHOO.util.DataSource.TYPE_JSARRAY;
	        dataSource.responseSchema = {
	            fields: ["Agent","Version","PID","Date"]
	        };
        var dataTable = new YAHOO.widget.ScrollingDataTable("phedex_agents_table", columnDefs, dataSource,
                     {
                      caption:"PhEDEx Agents on "+site,
                      height:'150px',
                      draggableColumns:true
                     });
	}
	that.update=function() {
	  PHEDEX.Data.Agents(site,this.receive,this);
	}
	that.receive=function(result) {
	  var data = result.responseText;
	  data = eval('('+data+')'); 
	  data = data['phedex']['node'];
	  if (data.length) {
	    result.argument.data = data[0];
	    result.argument.createHTML();
	    }	    
	}
	return that;
}

PHEDEX.Data = function() {}

PHEDEX.Data.Agents = function(site,callback,argument) {
  var c = YAHOO.util.Connect.asyncRequest('GET','/phedex/datasvc/json/prod/agents?node='+site,{success:callback,argument:argument});
}

//myagent_node = new PHEDEX.Node.Agents('T2_CH_CAF');
//myagent_node.update();

</script>
</body>
</html>
