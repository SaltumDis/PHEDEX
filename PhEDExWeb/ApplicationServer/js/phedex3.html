<!-- Combo-handled YUI CSS files: --> 
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?2.7.0/build/treeview/assets/skins/sam/treeview.css"> 
<!-- Combo-handled YUI JS files: --> 
<script type="text/javascript" src="http://yui.yahooapis.com/combo?2.7.0/build/yahoo/yahoo-debug.js&2.7.0/build/event/event-debug.js&2.7.0/build/connection/connection-debug.js&2.7.0/build/json/json-debug.js&2.7.0/build/dom/dom-debug.js&2.7.0/build/treeview/treeview-debug.js&2.7.0/build/logger/logger-debug.js"></script>

<script type="text/javascript" src="/readfile/phedex-node.js"></script>

<style type="text/css">
.node{}
.node-main{border:1px solid black;padding:2px 2px 2px 2px;background:#eee}
.node-children{padding-left:20px;display:none}
.node-header{background:#ddd}
.node-extra{display:none}
.node-extra-link{align:center;font-size:80%;font-family:courier;width:100%}
.node-extra-link:hover{background:#ccc}
.node-children-link{font-family:courier;font-weight:bold;border:1px solid black;background:grey;padding-left:2px;padding-right:2px;text-decoration:none;color:white}
.node-children-info{background:red}
.indent{padding-left:20px;display:none}
</style>

<html><head><title>Agents</title>

</head>
<body>
<div><input id='node_select' type='text' value='T1_US_FNAL_Buffer'><a href='#' onClick='return agents()'>Submit</a>
<div><input id='filter' type='text'><a href='#' onClick='return filter()'>Filter</a>
<div id='phedex_transfers'></div>

<script type='text/javascript'>

xfer_node=null;

agents=function() {
  var site = document.getElementById('node_select').value;
//  agent_node = new PHEDEX.Node.Agents(site);
//  agent_node.update();
//  to_node = new PHEDEX.Node.PendingTransfers(site,'to');
//  from_node = new PHEDEX.Node.PendingTransfers(site,'from');
//  to_node.update();
//  from_node.update();
  xfer_node = new Node.TransfersNode(site);
  xfer_node.update();
}

filter=function() {
  var filter = document.getElementById('filter').value;
  if (filter=='') {
    xfer_node.filterClear();
  } else {
    xfer_node.filterChildren(filter);
  }
}



Node.TransfersNode=function(site) {
  var that = new Node('phedex_transfers',null,{fixed_extra:true,expand_children:true});
  that.site = site;
  that.data_queue = [];
  that.data_hist = [];
  that.data_queue_blocks=[];
  that.data_arrived=0;
  that.mode='to';
  that.time='6';
  that.buildHeader=function(span) {}
  that.fillHeader=function() {
    this.span_header.innerHTML=this.site;
  }
  that.buildExtra=function(div) {
    div.innerHTML='';
    var modeselect = document.createElement('select');
    var incoming = document.createElement('option');
    var outgoing = document.createElement('option');
    incoming.text = 'Incoming Links';
    incoming.value = 'to';
    outgoing.text = 'Outgoing Links';
    outgoing.value = 'from';
    modeselect.appendChild(incoming);
    modeselect.appendChild(outgoing);
    modeselect.selectedIndex=0;

    var timeselect = document.createElement('select');
    timeselect.innerHTML = "<option value='1'>Last Hour</option><option value='3'>Last 3 Hours</option><option value='6' selected>Last 6 Hours</option><option value='12'>Last 12 Hours</option><option value='24'>Last Day</option><option value='48'>Last 2 Days</option><option value='96'>Last 4 Days</option><option value='168'>Last Week</option>";
    
    modeselect.setAttribute('onchange',"eventProxy('"+this.id+"','mode',this.value);");
    timeselect.setAttribute('onchange',"eventProxy('"+this.id+"','time',this.value);");

    div.appendChild(modeselect);
    div.appendChild(timeselect);
  }
  that.fillExtra=function() {
  
  }
  that.event=function(what,val,arg2,arg3) {
    if (what=='time') {
      this.time=val;
      this.update();
    }
    if (what=='mode') {
      this.mode=val;
      this.update();
    }
  }
  that.update=function() {
    this.data_arrived=0;
    var args={};
    args[this.mode]=this.site;//apparently {this.mode:this.site} is invalid
    args['binwidth']=parseInt(this.time)*3600;
    Data.Call('TransferQueueStats',args,this.receive,{call:'TransferQueueStats',obj:this});
    Data.Call('TransferHistory',args,this.receive,{call:'TransferHistory',obj:this});
  }
  that.receive=function(result) {
    if (result.argument.call=='TransferQueueStats') {
      result.argument.obj.data_queue = eval('('+result.responseText+')')['phedex']['link'];
      result.argument.obj.data_arrived += 1;
    }
    if (result.argument.call=='TransferHistory') {
      result.argument.obj.data_hist = eval('('+result.responseText+')')['phedex']['link'];
      result.argument.obj.data_arrived += 1;
    }
    if (result.argument.obj.data_arrived==2) {
      result.argument.obj.populate();    
    }
  }
  that.buildChildren=function(div) {
    this.children_info_div.innerHTML='';
    this.markChildren();
    if (this.mode=='to') var antimode='from';
    else var antimode='to';
    for (var i in this.data_queue) {
      var d = this.data_queue[i];
      var node = d[antimode];
      var h = {};
      for (var j in this.data_hist) {
        if (this.data_hist[j][antimode]==node) {
          h = this.data_hist[j];
          break;
        }
      }
      var id = this.id+'_'+this.mode+'_'+node;
      var child = this.getChild(id);
      if (child) {
        child.data_queue=d['transfer_queue'];
        child.data_hist=h;
        child.marked=false;
        child.update();
      } else {
        var childdiv = document.createElement('div');
        childdiv.id = id;
        div.appendChild(childdiv);
        var childnode = new Node.LinkNode(node,this.mode,this,childdiv,d['transfer_queue'],h);
        this.children.push(childnode);
        childnode.update();
      }
    }
    this.removeMarkedChildren();
    if (this.children.length==0) {
      this.children_info_div.innerHTML='No children returned';
    }
  }
  that.build();
  return that;
}

Node.LinkNode=function(site,mode,parent,div,data_queue,data_hist) {
  var that = new Node(div,parent);
  that.site=site;
  that.mode=mode;
  if (that.mode=='to') that.antimode='from';
  else that.antimode='to';
  that.data_queue=data_queue;
  that.data_hist=data_hist;
  that.queues=[];
  that.sum_queue_files=function() {
    var fsum=0;
    for (var i in this.data_queue) {
      fsum+= parseInt(this.data_queue[i]['files']);
    }
    return fsum;
  }
  that.sum_queue_bytes=function() {
    var bsum=0;
    for (var i in this.data_queue) {
      bsum+=parseInt(this.data_queue[i]['bytes']);
    }
    return bsum;
  } 
  that.hist_speed=function() {
    return parseInt(this.data_hist['done_bytes'])/parseInt(this.data_hist['timebin']);
  }
  that.buildHeader=function(span) {}
  that.fillHeader=function() {
    this.span_header.innerHTML=this.site+' '+this.hist_speed()+' B/s '+this.data_hist['done_files']+' files / '+this.data_hist['done_bytes']+' B quality:'+this.data_hist['quality']+' '+this.sum_queue_files()+' files / '+this.sum_queue_bytes()+' B queued';
  }
  that.buildExtra=function(div) {}
  that.fillExtra=function() {
    this.extra_div.innerHTML='Recent: '+this.data_hist['fail_files']+' failed / '+this.data_hist['expire_files']+' expired';
  }
  that.filter=function(filter_str) {
    if (filter_str.indexOf('link: ')>=0) {
      if (filter_str.indexOf(this.site)>=0) {
        return false;
      }
    }
    return true;
  }
  that.update=function() {
    this.populate();
  }
  that.buildChildren=function(div) {
    if (this.mode=='to') {
      var to = this.parent.site;
      var from = this.site;
    } else {
      var to = this.site;
      var from = this.parent.site;
    }
    Data.Call('TransferQueueBlocks',{from:from,to:to},this.receive,{obj:this,from:from,to:to});
  }
  that.receive = function(result) {
    
    this.queues = eval('('+result.responseText+')')['phedex']['link'];
    for (var i in this.queues) {
      for (var j in this.queues[i]['transfer_queue']) {
        var q_prio = this.queues[i]['transfer_queue'][j]['priority'];
        var q_stat = this.queues[i]['transfer_queue'][j]['state'];
        for (var k in this.queues[i]['transfer_queue'][j]['block']) {
          var block = this.queues[i]['transfer_queue'][j]['block'][k];
          var bdiv = document.createElement('div');
          result.argument.obj.children_div.appendChild(bdiv);
          bdiv.id = this.id+'_q'+j+'_b'+k;
          var node = new Node.BlockNode(result.argument.from,result.argument.to,this,bdiv,block,q_prio,q_stat);
          result.argument.obj.children.push(node);
          node.update();
        }
      }
    }
  }
  that.build();
  return that;
}

Node.BlockNode = function(from,to,parent,div,data,queue_priority,queue_status) {
  var that = new Node(div,parent);
  that.from=from;
  that.to=to;
  that.data=data;
  that.q_p = queue_priority;
  that.q_s = queue_status;
  that.files=[];
  that.buildHeader=function(span) {}
  that.fillHeader=function() {
    this.span_header.innerHTML='block: '+this.data['name']+' queue: '+this.q_p+' '+this.q_s;
  }
  that.buildExtra=function(div) {}
  that.fillExtra=function() {
    this.extra_div.innerHTML='id: '+this.data['id']+' files: '+this.data['files']+' bytes: '+this.data['bytes'];
  }
  that.update=function() {
    this.populate();
  }
  that.buildChildren=function(div) {
    var block = this.data['name'].replace(/#/,'%23');
    Data.Call('TransferQueueFiles',{from:this.from,to:this.to,block:block},this.receive,{obj:this,from:this.from,to:this.to,block:block});
  }
  that.receive=function(result) {
    this.files=eval('('+result.responseText+')')['phedex']['link'];
    for (var i in this.files) {
      for (var j in this.files[i]['transfer_queue']) {
        for (var k in this.files[i]['transfer_queue'][j]['block']) {
          for (var l in this.files[i]['transfer_queue'][j]['block'][k]['file']) {
            var f = this.files[i]['transfer_queue'][j]['block'][k]['file'][l];
            var fdiv = document.createElement('div');
            result.argument.obj.children_div.appendChild(fdiv);
            fdiv.id = this.id+'_f'+l;
            var node = new Node.FileNode(result.argument.from,result.argument.to,result.argument.block,this,fdiv,f);
            result.argument.obj.children.push(node);
            node.update();
          }
        }
      }
    }
  }
  that.build();
  return that;
}

Node.FileNode = function(from,to,block,parent,div,data) {
  var that = new Node(div,parent,{children:false});
  that.from=from;
  that.to=to;
  that.block=block;
  that.data=data;
  that.buildHeader=function(span) {}
  that.fillHeader=function() {
    this.span_header.innerHTML='name: '+this.data['name'];
  }
  that.buildExtra=function(div) {}
  that.fillExtra=function() {
    this.extra_div.innerHTML='id: '+this.data['id']+' checksum: '+this.data['checksum']+' bytes: '+this.data['bytes'];
  }
  that.update=function() {
    this.populate();
  }
  that.build();
  return that;
}



Data = function() {}

Data.Agents = function(site,callback,argument) {
  var c = YAHOO.util.Connect.asyncRequest('GET','/phedex/datasvc/json/prod/agents?node='+site,{success:callback,argument:argument});
}

Data.PendingTransfers = function(site,mode,callback,argument) {
  var c = YAHOO.util.Connect.asyncRequest('GET','/phedex/datasvc/json/prod/TransferQueueStats?'+mode+'='+site,{success:callback,argument:argument});
}

Data.Call = function(query,args,callback,argument) {
  var argstr = "";
  if (args) {
    argstr = "?";
    for (a in args) {
      argstr+=a+"="+args[a]+";";
    }
  }
  var url = '/phedex/datasvc/json/prod/'+query+argstr;
  var c = YAHOO.util.Connect.asyncRequest('GET',url,{success:callback,argument:argument});
}

//var site='T2_CH_CAF';
//var agent_node = new PHEDEX.Node.Agents(site);
//agent_node.update();


</script>
</body>
</html>

