<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <title>PhEDEx datasvc</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15" />

  <link rel="stylesheet" type="text/css" href="/yui/build/treeview/assets/skins/sam/treeview.css">
  <link rel="stylesheet" type="text/css" href="/yui/build/datatable/assets/skins/sam/datatable.css">
  <link rel="stylesheet" type="text/css" href="/yui/build/container/assets/container-core.css">
  <link rel="stylesheet" type="text/css" href="/yui/build/resize/assets/skins/sam/resize.css"> 
  <link rel="stylesheet" type="text/css" href="/yui/build/logger/assets/skins/sam/logger.css">
  <link rel="stylesheet" type="text/css" href="/yui/build/menu/assets/skins/sam/menu.css">
  <link rel="stylesheet" type="text/css" href="/yui/examples/treeview/assets/css/menu/tree.css">
  <link rel="stylesheet" type="text/css" href="/yui/build/button/assets/button-core.css">
  <link rel="stylesheet" type="text/css" href="/yui/build/assets/skins/sam/button.css">

  <script type="text/javascript" src="/yui/build/yahoo/yahoo-min.js"></script>
  <script type="text/javascript" src="/yui/build/event/event-min.js"></script>
  <script type="text/javascript" src="/yui/build/connection/connection-min.js"></script>
  <script type="text/javascript" src="/yui/build/json/json-min.js"></script>
  <script type="text/javascript" src="/yui/build/dom/dom-min.js"></script>
  <script type="text/javascript" src="/yui/build/treeview/treeview-min.js"></script>
  <script type="text/javascript" src="/yui/build/logger/logger-min.js"></script>
  <script type="text/javascript" src="/yui/build/yahoo-dom-event/yahoo-dom-event.js"></script>
  <script type="text/javascript" src="/yui/build/dragdrop/dragdrop-min.js"></script>
  <script type="text/javascript" src="/yui/build/element/element-min.js"></script>
  <script type="text/javascript" src="/yui/build/datasource/datasource-min.js"></script>
  <script type="text/javascript" src="/yui/build/datatable/datatable-min.js"></script>
  <script type="text/javascript" src="/yui/build/animation/animation-min.js"></script>
  <script type="text/javascript" src="/yui/build/container/container-min.js"></script>
  <script type="text/javascript" src="/yui/build/resize/resize-min.js"></script>
  <script type="text/javascript" src="/yui/build/menu/menu-min.js"></script>
  <script type="text/javascript" src="/yui/build/button/button-min.js"></script>

  <script type="text/javascript" src="/js/phedex-base.js"></script>
  <script type="text/javascript" src="/js/phedex-core-logger.js"></script>
  <script type="text/javascript" src="/js/phedex-core-contextmenu.js"></script>
  <script type="text/javascript" src="/js/phedex-util.js"></script>
  <script type="text/javascript" src="/js/phedex-page.js"></script>
  <script type="text/javascript" src="/js/phedex-datasvc.js"></script>
  <script type="text/javascript" src="/js/phedex-core-widget.js"></script>
  <script type="text/javascript" src="/js/phedex-core-widget-datatable.js"></script>
  <script type="text/javascript" src="/js/phedex-core-widget-treeview.js"></script>
  <script type="text/javascript" src="/js/phedex-widget-agents.js"></script>
  <script type="text/javascript" src="/js/phedex-widget-nodes.js"></script>
  <script type="text/javascript" src="/js/phedex-widget-linkview.js"></script>
  <script type="text/javascript" src="/js/phedex-widget-requestview.js"></script>
  <link rel="stylesheet" type="text/css" href="/css/phedex.css">

<script type="text/javascript">
  var mypolls = {};

  var recieveme = function(data, context) {
    var msg;
    if ( data instanceof Error ) {
      msg = 'api \''+context.api+'\' ' +
           ' poll_id: '+context.poll_id +
           ' poll_ number: '+context.poll_number +
           ' returned an error: "'+data.message+'"';
    } else {
      msg = data.bounce.value+': ' +
           ' poll_id: '+context.poll_id +
           ' poll_number: '+context.poll_number +
	   ' OK: '+data.request_date;
    }	   
    var li = document.createElement('li');
    li.innerHTML = msg;
    var ul = document.getElementById('polltest');
    ul.appendChild(li);
  }

  var myevent = new YAHOO.util.CustomEvent('TestPollEvent');
  var start_listening = function() {
     myevent.subscribe(function (type, data) { recieveme(data[0], data[1]); });  
  }
  start_listening();

  var start_poll_test = function(value, polltime) {
    var args = { value:value };
    if (value == 'die') { args.die = 1 }
    mypolls[value] = PHEDEX.Datasvc.Poll({api:'bounce',
	    	                          args:args,
					  success_event:myevent,
 			                  force_polltime:polltime,
		                          limit:10});
  }

  var stop_poll_test = function(value) {
    alert('stopping poll test '+value+' with id '+mypolls[value]);
    PHEDEX.Datasvc.stopPoll(mypolls[value]);
  }

  var stop_listening = function() {
     alert('no longer listening');
     myevent.unsubscribeAll();
  }
</script>

</head>

<body class="yui-skin-sam">
 <div id='phedex_logger' style='float:right;'></div>
 <div id='phedex_main'></div>

<script type="text/javascript">
// This Page.Config object defines the page structure, using JSON
Page = { 'Config': [
  {call:'Nodes',         value:'',                  text:'Show Nodes'},
  {call:'TransfersNode', value:'T1_US_FNAL_Buffer', text:'Show Links', opts:{time:12,direction:'from'} },
  {call:'Requests',      value:'30342',             text:'Show Requests' },
  {call:'Agents',        value:'T1_US_FNAL_Buffer', text:'Show Agents for node' }
 ] };

// instantiate the page and other things when the DOM is ready!
YAHOO.util.Event.onDOMReady(function() {
      PHEDEX.Logger.Create(
	    {width:'650px',height:'30em'}, // arguments to the YAHOO LogReader widget
	    {				   // options to the PHEDEX.Logger
	      collapse:false,
	      hideSource:['Core.ContextMenu','Core.DataTable','Core.TransfersNode','Core.Widget']
	    }
	);
      PHEDEX.Page.Create(Page.Config);
    });
</script>

<input type="submit" target="#" onclick="start_poll_test('xxx', 10000)" value="start 'xxx' test"/>
<input type="submit" target="#" onclick="start_poll_test('yyy', 5000)"  value="start 'yyy' test"/>
<input type="submit" target="#" onclick="start_poll_test('zzz', 1000)"  value="start 'zzz' test"/>
<input type="submit" target="#" onclick="start_poll_test('die', 10000)"  value="start 'die' test"/>
<br/>
<input type="submit" target="#" onclick="stop_poll_test('xxx')" value="stop 'xxx' test"/>
<input type="submit" target="#" onclick="stop_poll_test('yyy')" value="stop 'yyy' test"/>
<input type="submit" target="#" onclick="stop_poll_test('zzz')" value="stop 'zzz' test"/>
<input type="submit" target="#" onclick="stop_poll_test('die')" value="stop 'die test"/>
<br/>
<input type="submit" target="#" onclick="stop_listening()" value="stop listening"/>
<input type="submit" target="#" onclick="start_listening()" value="start listening"/>
<p><b>Poll Results:</b></p>
<ul id="polltest"></ul>

</body>
</html>
