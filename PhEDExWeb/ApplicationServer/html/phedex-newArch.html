<!DOCTYPE HTML PUBLIC “-//W3C//DTD HTML 4.01//EN” “http://www.w3.org/TR/html4/strict.dtd”>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <title>PhEDEx Web Application</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15" />
<!--define basic CSS for the body here (fonts etc), so the page doesn't wobble when css files get loaded later.-->
  <style type='text/css'>
    body {
      margin:           0;
      margin-left:      1em;
      padding:          0;
      font-size:        80%;
      font-family:      'Lucida Grande', verdana, helvetica, arial, sans-serif;
      line-height:      1.6em;
    }
  </style>
</head>

<body class="yui-skin-sam">
 <iframe id="yui-history-iframe" src="/phedex/datasvc/app/images/phedex-logo-small.gif" style='visibility:hidden'></iframe>
 <input id="yui-history-field" type="hidden" style='visibility:hidden'>
<div id='tony'></div>
 <div class='phedex-banner'>
    <a href='' id='phedex-link-home' title='Reset application to initial state' style='text-decoration:none'>
      <img src="/phedex/datasvc/app/images/phedex-logo-small.gif" alt="PhEDEx" height="20" style='border:none'/>
    </a>
    <b>PhEDEx Next-Gen Web Application - v.<span id='phedex-app-version'></span></b> -
    <a target='new_twiki' title='PhEDEx website planning twiki' href="https://twiki.cern.ch/twiki/bin/view/CMS/PhedexProjWebsite">plan</a> -
<!-- based on http://reliableanswers.com/js/mailme.asp -->
    <a href="/contact/" title="Send us feedback about this site"
       onmouseover="javascript:this.href=mailMe('cern%23ch','cms-phedex-admins');"
       onfocus="javascript:this.href=mailMe('cern%23ch','cms-phedex-admins');"
       >feedback email</a> -
    <a target='new_bugs' title='PhEDEx Savannah bug-reporting and feature requests' href="https://savannah.cern.ch/bugs/?func=additem&group=phedex">bugs/feature req.</a> -
    <span id='phedex-banner-messages-outer' class='phedex-messages-outer'>
      <span id='phedex-banner-messages-inner' class='phedex-messages-inner'>Loading, please be patient...</span>
    </span>
    <div id='phedex-controls' class='phedex-controls float-right'></div>
 </div>
 <div id='phedex-login'></div>
 <div id='phedex-navigator'></div>
 <div class='phedex-separator'></div>
 <div id='phedex-logger' class='phedex-logger'>
  <div id='phedex-logger-inner' class='phedex-logger-inner'></div>
 </div>
 <div id='phedex-debug' class='float-right'></div>
 <div id='phedex-test'></div>
 <div id='phedex-main'></div>

<!-- The following section is to
     1. Give google something to index
     2. Notify people without javascript -->
<noscript>
<p>(<b>Note:</b> Javascript is required to use the PhEDEx Web
    Application.  The following description is intended for
    web-crawlers).</p>
<h1>PhEDEx - Physics Experiment Data Export</h1>
<p>PhEDEx is the data transfer system used by the CMS experiment at CERN.</p>

<h2>Javascript is Required!</h1>
<p>The PhEDEx Web Application requires a browser with javascript
available and enabled.  We recommend the latest version of Mozilla
Firefox, available <a href='http://www.mozilla.com/firefox/'>here</a>.</a>

<p>If it is not possible for you to use a browser with javascript, you
can write scripts to use the data service directly.  Data service
documentation is found
<a href='/phedex/datasvc/doc'>
here</a>.</p>
</noscript>

</body>

<script type="text/javascript" src="/yui/build/yuiloader-dom-event/yuiloader-dom-event.js"></script>
<script type="text/javascript" src="/js/phedex-loader.js"></script>
<script type="text/javascript">
function mailMe(sDom, sUser){ return("mail"+"to:"+sUser+"@"+sDom.replace(/%23/g,".")); }

stressTest = function(type) {
  var el = document.getElementById('phedex-debug'),
      d  = document.getElementById('phedex-debug-status'),
      i  = 0,
      run = 1;
  if ( !d ) {
    d = document.createElement('div');
    d.id = 'phedex-debug-status';
    el.appendChild(d);
  }
  d.innerHTML='starting...';
  var start = new Date();
  var moduleHandler = function(who,arr) {
    switch ( arr[0] ) {
      case 'gotData': {
        if ( run == 0 ) { break; }
        PxS.notify('module',who,'destroy');
        break;
      }
      case 'destroy': {
        if ( run == 0 ) { break; }
        i++;
        d.innerHTML = 'iterations so far: '+i;
        setTimeout(function() { PxS.notify('CreateModule',type); }, 0);
        break;
      }
    }
  };

  var _moduleExists = function(ev,arr) {
    PxS.listen(arr[0].id,moduleHandler);
  };
  PxS.listen('ModuleExists', _moduleExists);
  setTimeout(function() {
      run = 0;
      var stop = new Date();
      stop = (stop.getTime() - start.getTime())/1000;
      d.innerHTML += '<br />Test took '+stop+'seconds';
    }, 60000);
  PxS.notify('CreateModule',type);
}

makeNavigator = function() {
  PxS.notify('Load','phedex-navigator', {
    el: 'phedex-navigator',
    cfg: {
      typecfg: {
        none:   { label: 'Explore global',  order: 10 },
        node:   { label: 'Explore by node', order: 20 },
        static: { label: 'Explore Information', order: 30 }
      }
    }
  });
};

var fn=[];
debugLinks = function() {
// cheat, providing a few links to create modules from...
  var el = document.getElementById('phedex-debug'),
      methods = [ 'show','hide','destroy' ];
  el.appendChild(document.createTextNode('Core operations (all modules)'));
  for (var i in methods) {
    var div = document.createElement('div'),
        a   = document.createElement('a');
    a.href='#';
    a.innerHTML = methods[i];
    a.setAttribute('onclick',"PxS.notify('module','*','"+methods[i]+"');");
    div.appendChild(a);
    el.appendChild(div);
  };
  el.appendChild(document.createTextNode('Create module(s)'));
  var modules = PxL.knownModules();
  for (var i in modules) {
    var div = document.createElement('div'),
        a   = document.createElement('a');
    a.href='#';
    a.innerHTML = modules[i];
    a.setAttribute('onclick',"PxS.notify('CreateModule','"+modules[i]+"');");
    div.appendChild(a);
    el.appendChild(div);
  }

    var div = document.createElement('div'),
        a   = document.createElement('a');
    a.href='#';
    a.innerHTML = 'navigator';
    a.setAttribute('onclick','makeNavigator()');
    div.appendChild(a);
    el.appendChild(div);

  el.appendChild(document.createTextNode('Stress-test modules'));
  modules.push('dummy');
  for (var i in modules) {
    var type = PxU.initialCaps(modules[i]);
    var d = document.createElement('div');
    var a = document.createElement('a');
    a.href='#';
    a.innerHTML = '"infinite" '+type;

    a.setAttribute('onclick',"stressTest('"+type+"')");
    d.appendChild(a);
    el.appendChild(d);
  }

//   el.appendChild(document.createTextNode('Load objects'));
//   var objects = PxL.knownObjects();
//   for (var i in objects) {
//     var div = document.createElement('div'),
//         a   = document.createElement('a');
//     a.href='#';
//     a.innerHTML = objects[i];
//     fn[i] = function(obj) {
//       return function() {
//         PxL.load({
//               Success:  function(item) { banner('Successfully loaded '+obj); },
//               Progress: function(item) { banner('Loaded item: '+obj); },
//               Failure:  function(item) { banner('Failed to load '+obj); }
//         },obj);
//       }
//     }(objects[i]);
// 
//     a.setAttribute('onclick',"fn["+[i]+"]();");
//     div.appendChild(a);
//     el.appendChild(div);
//   }
}

// When the DOM is available, start loading the essential bits and pieces
// This is where the real application starts.
YAHOO.util.Event.onDOMReady(function() {
  banner('Loading core application...');
  PxL  = new PHEDEX.Loader();
  PxL.load(createCoreApp,'core','sandbox','datasvc','registry');

  var phedex_app_version = document.getElementById('phedex-app-version');
  if ( phedex_app_version ) { phedex_app_version.innerHTML = PHEDEX.Appserv.Version; }
  var phedex_home = document.getElementById('phedex-link-home');
  if ( phedex_home ) {
    var uri = location.href;
    uri.replace(/#.*$/g,'');
    phedex_home.href = uri;
  }
});

function createCoreApp() {
// This is called once the core is fully loaded. Now I can create the core
// application and sandbox, and then start creating PhEDEx modules
  banner('Create sandbox and core application...');
  try {
    PxS = new PHEDEX.Sandbox();
  } catch(ex) { log(ex,'error',name); banner('Error creating sandbox!'); return; }
  try {
    PxC = new PHEDEX.Core(PxS,PxL);
    PxC.create();
  } catch(ex) { log(ex,'error',name); banner('Error creating Core application!'); return; }
  try {
    PxR = new PHEDEX.Registry(PxS);
    PxR.create();
  } catch(ex) { log(ex,'error',name); banner('Error creating Registry!'); return; }

  if ( PxR ) { // TODO this needs a better home!
    PxS.notify('Registry', 'add', 'phedex-module-agents',   'node', 'Show Agents', {context_item:true});
    PxS.notify('Registry', 'add', 'phedex-module-nodes',    'none', 'Show Nodes');
    PxS.notify('Registry', 'add', 'phedex-module-linkview', 'node', 'Show Links',  {context_item:true});
  }

  banner('Core application is running, ready to create PhEDEx data-modules...');
  // Load and create the navigator!
  PxS.notify('Load','phedex-navigator', {
    el: 'phedex-navigator',
    cfg: {
      typecfg: {
        none:   { label: 'Explore global',  order: 10 },
        node:   { label: 'Explore by node', order: 20 },
        static: { label: 'Explore Information', order: 30 }
      }
    }
  });

  PxS.notify('Load','phedex-login', {el: 'phedex-login'});

// Create the logger element, if required...
  if ( 1 ) {
    PxL.load(function() {
      PHEDEX.Logger.Create();
      var ctl = new PHEDEX.Component.Control(PxS,{
          payload: {
            text:'Show Logger',
            target:'phedex-logger',
            animate:true,
            className: 'float-right phedex-core-control-widget phedex-core-control-widget-inactive',
          }
        }
      );
      document.getElementById('phedex-controls').appendChild(ctl.el);
      document.getElementById('phedex-controls').appendChild(ctl.el);
      ctl = new PHEDEX.Component.Control(PxS,{
          payload: {
            text:'Debug controls',
            target:'phedex-debug',
            className: 'float-right phedex-core-control-widget phedex-core-control-widget-inactive',
          }
        }
      );
      document.getElementById('phedex-controls').appendChild(ctl.el);
      ctl.Show();
      debugLinks();
      ctl.Show();
    },'logger','component-control');
  }

  PHEDEX.Util.bannerIdleTimer(PxL);
};
</script>
</html>