*** 2005-06-09

-- Generate three passwords (repeat until good passwords)
sh Utilities/WordMunger
sh Utilities/WordMunger
sh Utilities/WordMunger

-- Initialise passwords (prompted on first login, just exit)
sqlplus cms_transfermgmt_sc@cmssg
sqlplus cms_transfermgmt_sc_reader@cmssg
sqlplus cms_transfermgmt_sc_writer@cmssg

-- Load initial schema
cd Schema
perl -p -i -e 's/([ ])CMS_TRANSFERMGMT_INDX01/${1}CMS_TRANSFERMGMT_SC_INDX01/g' *.sql
sqlplus cms_transfermgmt_sc/<password>@cmssg @OracleInit.sql
perl -p -i -e 's/([ ])CMS_TRANSFERMGMT_SC_INDX01/${1}CMS_TRANSFERMGMT_INDX01/g' *.sql
cd ..

-- Create roles and apply privileges
sh Utilities/WordMunger
Schema/OracleNewRole.sh cms_transfermgmt_sc/<password>@cmsssg \
  site_cern <newpass>
Schema/OraclePrivs.sh cms_transfermgmt_sc/<password>@cmssg \
  cms_transfermgmt_sc_reader cms_transfermgmt_sc_writer
Schema/OracleSyns.sh cms_transfermgmt_sc \
  cms_transfermgmt_sc/<password>@cmssg \
  cms_transfermgmt_sc_reader/<password>n@cmssg
Schema/OracleSyns.sh cms_transfermgmt_sc \
  cms_transfermgmt_sc/<password>@cmssg \
  cms_transfermgmt_sc_writer/<password>n@cmssg

sqlplus cms_transfermgmt_sc/<password>@cmsssg
  insert into t_authorisation values (1118335369, 'SITE_CERN',
     'lassi.tuura@cern.ch', '/C=CH/O=CERN/OU=GRID/CN=Lassi Tuura 3370');

-- Prepare DBParam
Section                 SC3/Admin
Interface               Oracle
Database                cmssg
AuthDBUsername          cms_transfermgmt_sc
AuthDBPassword          <password>
ConnectionLife          86400
LogConnection           on
LogSQL                  off

Section                 SC3/CERN
Interface               Oracle
Database                cmssg
AuthDBUsername          cms_transfermgmt_sc_writer
AuthDBPassword          <password>
AuthRole                site_cern
AuthRolePassword        <password>
ConnectionLife          86400
LogConnection           on
LogSQL                  off

Section                 SC3/Reader
Interface               Oracle
Database                cmssg
AuthDBUsername          cms_transfermgmt_sc_reader
AuthDBPassword          <passsword>
ConnectionLife          86400
LogConnection           on
LogSQL                  off

-- Test
Utilities/DBDump -db Schema/DBParam:SC3/Admin t_node
Utilities/DBDump -db Schema/DBParam:SC3/CERN t_node
Utilities/DBDump -db Schema/DBParam:SC3/Reader t_node

-- Stats
Schema/OracleStatsEnable.sh cms_transfermgmt_sc/<password>@cmssg
Schema/OracleStatsUpdate.sh cms_transfermgmt_sc/<password>@cmssg

-- Copy data
sqlplus cms_transfermgmt_sc/<password>@cmssg
  insert into t_node values ('T1_CERN_MSS');

./Utilities/NodeNew T1_CERN_Buffer srm:gsiftp srm:gsiftp T1_CERN_MSS:1 |
   sqlplus cms_transfermgmt_sc/<password>@cmssg

sqlplus cms_transfermgmt_sc_writer/<password>@cmssg
  set role site_cern identified by <password>;
  copy from cms_transfermgmt/<password>@cms insert t_file using
    select * from t_file where filesize >= 400*1024*1024 and node like 'T1_CERN%';
  copy from cms_transfermgmt/<password>@cms insert t_file_attributes using
    select * from t_file_attributes where guid in
      (select guid from t_file where filesize >= 400*1024*1024 and node like 'T1_CERN%');
  insert into t_replica_state
      (select timestamp, guid, 'T1_CERN_MSS', 0, timestamp from t_file);
  insert into t_block
      (select min(timestamp), inblock, substr(inblock, 1, instr(inblock, '/')-1),
              substr(inblock, instr(inblock, '/')+1), count(guid), sum(filesize), 1
       from t_file group by inblock);

-- On cmsgate, initialise agent area
cd /data
mkdir SC3Nodes
cd SC3Nodes
ln -s ../V2Nodes/gridcert .
cvs -d :pserver:anonymous@cmscvs.cern.ch:/cvs_server/repositories/PHEDEX co PHEDEX

mkdir tools
VO_CMS_SW_DIR=/afs/cern.ch/sw PHEDEX/Deployment/InstallPOOL -arch SLC3 -cms $PWD/tools
PHEDEX/Deployment/InstallOracleClient /data/oracle $PWD/tools
PHEDEX/Deployment/InstallPerlModules $PWD/tools

# scp Schema/DBParam phedex@cmsgate.cern.ch:/data/SC3Nodes/PHEDEX/Schema
: source ./tools/poolenv.sh
/data/SC3Nodes
: source ./tools/oraenv.sh 
: source ./tools/perlenv.sh
PHEDEX/Deployment/TestInstallation -db PHEDEX/Schema/DBParam:SC3/CERN \
  -poolcat mysqlcatalog_mysql://phedex:phedex@cmslcgco04/phedexcat

-- Cycle agents
PHEDEX/Utilities/Master -config PHEDEX/Custom/CERN/Config.SC3 start
PHEDEX/Utilities/Master -config PHEDEX/Custom/CERN/Config.SC3 stop

-- Make sure others can operate it all
chgrp -R phedex /data/SC3Nodes
chmod -R g+w /data/SC3Nodes
chmod o-rwx /data/SC3Nodes/PHEDEX/Schema/DBParam


*** 2005-06-10

-- Mark all blocks closed in sqlplus
update t_block set isopen = 0;
