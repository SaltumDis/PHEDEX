#!/usr/bin/env perl

use strict;
use warnings;
use CGI qw(:standard);
use CGI::Carp qw(fatalsToBrowser);
use POSIX;

my $cgi = new CGI;

# ###############################################
# Main loop
# ###############################################

intro();
end();

# ###############################################
# Subroutines
# ###############################################
sub relurl
{
    my %args = ();
    my $newcgi = new CGI ($cgi->query_string);
    map { $newcgi->param ($_, $args{$_}) } keys %args;
    return $newcgi->self_url(-full=>0, -relative=>1);
}

sub intro
{
    $| = 1;

    my $stamp = strftime ("%Y-%m-%d %H:%M:%S %Z", localtime(time()));
    print $cgi->header();

    print "
        <head>
        <title>PhEDEx monitoring</title>
        <meta http-equiv=\"refresh\" content=\"5\">
        </head>
        <body>
        <h1>PhEDEx Monitoring</h1>
        <p>$stamp
        <a href='}, &relurl('page', 'main'), qq{'>Front page</a>
       	<a href='}, &relurl('page', 'transfer'), qq{'>Transfer state</a>
       	<a href='}, &relurl('page', 'replicas'), qq{'>Replica state</a>
       	<a href='}, &relurl('page', 'subs'), qq{'>Subscriptions</a>
       	<a href='}, &relurl('page', 'stats'), qq{'>File size stats</a>
       	<a href='}, &relurl('page', 'rates'), qq{'>Transfer rate</a>
       	<a href='}, &relurl('page', 'agents'), qq{'>Agent status</a>
    ";
    
    if ($cgi->param('page')) { print $cgi->param('page'); }
}

sub end
{
    print "</body></html>\n";
}