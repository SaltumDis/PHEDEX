#!/usr/bin/env perl

##H Parallel reliable file download agent.
##H
##H This agent monitors TMDB for files assigned to the agent, and
##H manages their download.  A separate backend (Globus, SRM, ...)
##H handles the actual transfer steps.  A configurable number of
##H files is always kept in transfer, using subprocesses to manage
##H transfers and other tasks as appropriate.  The again maintains
##H a local pool of transfer work and uploads file transfer report
##H to the database every once in a while.
##H
##H The agent creates batches of transfer "jobs" out of its queue
##H of files to transfer.  As files complete transfer, the agent
##H verifies transfer completeness, and then uploads the full
##H transfer report back to the database where the central file
##H mover manages the rest.
##H
##H Interaction with the site infrastructure is through scripts
##H named in command line arguments.  The required tools are
##H described in detail in the manual.  The general syntax is
##H CMD[,ARG...], where CMD is the actual command to execute,
##H followed by comma-separated list of arguments to pass to it.
##H
##H Usage:
##H   FileDownload
##H      -state DIRECTORY -nodes PATTERN[,PATTERN...]
##H      -db FILE[:SECTION] [-log OUT] [-verbose]
##H      [-ignore NODE[,NODE...]] [-accept NODE[,NODE...]]
##H      [-validate CMD[,ARG...]] [-delete CMD[,ARG...]]
##H      -backend TYPE [OPTIONS]
##H
##H -state       agent state directory
##H -nodes       patterns for the node names for which this agent runs
##H -db          database connection configuration parameter file
##H -log         where to redirect logging information
##H -verbose     include more information about internal algorithms
##H
##H -ignore      comma-separated list of nodes to ignore transfers from
##H -accept      comma-separated list of nodes to accept transfers from
##H -validate    command to verify file transfer success
##H -delete      command to delete file on failure
##H
##H -backend     the transfer backend to use: Globus, SRM, FTS, DCCP; all
##H               options that follow are passed to the backend as such
##H
##H Options to all backends:
##H      [-protocols NAME[,NAME...]] [-timeout SECS]
##H
##H Options to Null backend:
##H      (none)
##H
##H Options to Globus backend:
##H      [-command CMD[,ARG...]] [-jobs NJOBS]
##H
##H Options to SRM backend:
##H      [-command CMD[,ARG...]] [-batch-files N] [-jobs NJOBS]
##H
##H Options to FTS backend:
##H      [-service CONTACT | -mapfile FILE]
##H      [-batch-files N] [-link-pending-files N] [-max-active-files N]
##H
##H -protocols   comma-separated list of storage protocols to accept
##H -batch-files number of files per transfer batch (SRM, FTS; default: 30)
##H -jobs        maximum number of concurrent transfer jobs (default: 5)
##H -timeout     execution time limit for commands (default: 3600)
##H -command     override the transfer command, for instance
##H               globus-url-copy,-p,3,-tcp-bs,2097152
##H -service     FTS server to use
##H -mapfile     A map of SRM endpoint:FTS endpoint, if not specified BDII service 
##H              discovery used instead
##H -link-pending-files  limit to the number of files allowed to be in the "pending" state per link
##H -max-active-files    limit to the total number of files allowed to be in the "active" state
##H -link-active-files   limit the total number of "active" files per link. Can
##H                      be repeated for several links, takes the form 'link=n'
##H                      to specify the number 'n' for a given link.
##H -myproxy     myproxy server specification
##H -passfile    FTS password file
##H -spacetoken  a single SRM spacetoken to use with all transfers
##H -j_interval  interval for polling the FTS queue for job status. Not normally
##H              needed
##H -priority    priority mapping from PhEDEx to FTS states. Not for normal use

######################################################################
my %args = (CMDLINE => [ @ARGV ]);
use Getopt::Long;
use PHEDEX::File::Download::Agent;
use PHEDEX::Core::Help;


&GetOptions ("state=s"     => \$args{DROPDIR},
	     "log=s"       => \$args{LOGFILE},
             "db=s"        => \$args{DBCONFIG},
	     "verbose"     => \$args{VERBOSE},
             "nodes=s"     => sub { push(@{$args{NODES}},
					 split(/,/, $_[1])) },

             "ignore=s"    => sub { push(@{$args{IGNORE_NODES}},
					 split(/,/, $_[1])) },
             "accept=s"    => sub { push(@{$args{ACCEPT_NODES}},
					 split(/,/, $_[1])) },

             "validate=s"  => sub { push(@{$args{VALIDATE_COMMAND}},
					 split(/,/, $_[1])) },
             "delete=s"    => sub { push(@{$args{DELETE_COMMAND}},
					 split(/,/, $_[1])) },

             "backend=s"   => sub { $args{BACKEND_TYPE} = $_[1]; die "!FINISH"; },

	     "help|h"      => sub { &usage() },
            );

die "Insufficient parameters, use -h for help.\n"
    if (!$args{DROPDIR} || !$args{NODES} || !$args{DBCONFIG}
	|| !$args{BACKEND_TYPE});

my $agent = PHEDEX::File::Download::Agent->new(%args, BACKEND_ARGS => [ @ARGV ]);
POE::Kernel->run();
print "POE kernel has ended, now I shoot myself\n";
exit 0;
