#!/usr/bin/env python
"""
_DBSMigrateDataset_

Command line tool to migrate a dataset/block from a DBSa to a DBSb.

"""
from DBSAPI.dbsApi import DbsApi
from DBSAPI.dbsException import *
from DBSAPI.dbsApiException import *

import sys,os,getopt
                  
def MigrateDataset (srcDBS,destDBS,dataset,block,no_parents):
  """
  Migrate blocks of a dataset to a destination DBS.
  """
  #//
  #// Global DBS API
  #//
  args = {'url' : srcDBS}
  dbsapi = DbsApi(args)
     
  print "++ Migrating dataset %s"%dataset
  print "+ from DBS: \t\t%s "%srcDBS
  print "+ to DBS: \t\t%s "%destDBS
  print "+ no parentage: \t%s "%no_parents
    
  try:
      dbsapi.migrateDatasetContents(srcDBS,destDBS,dataset,block,noParentsReadOnly=no_parents)

  except DbsApiException, ex:
    print "Caught API Exception %s: %s "  % (ex.getClassName(), ex.getErrorMessage() )
    if ex.getErrorCode() not in (None, ""):
      print "DBS Exception Error Code: ", ex.getErrorCode()
    sys.exit(1)

  print ">> Block %s from dataset %s was successfuly migrated"%(block,dataset)

  return

def main ():
  from optparse import OptionParser
                                                     
  usage="""\n Usage: python DBSMigrateDataset <options> 
              Options:  
              --srcDBS=<From DBS> \t\t Source DBS URL (default: http://cmsdbsprod.cern.ch/cms_dbs_prod_global/servlet/DBSServlet) 
              --destDBS=<To DBS>  \t\t Destination DBS URL  
              --datset=<dataset>  \t\t Bataset to migrate  
              --block=<block>     \t\t Block to migrate (default: the whole dataset will be migrated)
              --parents           \t\t Migrate using parentage (default: False) \n"""

  parser = OptionParser(usage=usage)

  parser.add_option('-s', '--srcDBS', dest='srcDBS', 
                     default='http://cmsdbsprod.cern.ch/cms_dbs_prod_global/servlet/DBSServlet',
                     help='Source DBS URL')
  parser.add_option('-t', '--destDBS', dest='destDBS', help='Target DBS URL')
  parser.add_option('-d', '--dataset', dest='dataset', help='Dataset to be migrated')
  parser.add_option('-b', '--block', dest='block', default='', help='Block to be migrated')
  parser.add_option('-p', '--parents', action="store_false",
                    default=True,dest='no_parents', help='Migrate dataset with parentage')

  (opts, args) = parser.parse_args()

  if not opts.destDBS or not opts.dataset:
    raise Exception("Either --destDBS or --dataset is missing")

  MigrateDataset(opts.srcDBS,opts.destDBS,opts.dataset,opts.block,opts.no_parents)
    
  sys.exit(0)

if __name__ == "__main__":
  main()
