#!/usr/bin/perl

##H Set the destination locations for the transfer request.
##H
##H Usage: TRNewLoc [-r] REQUEST [DEST...]
##H
##H REQUEST is the request directory previously created with TRNew.
##H Adds all the DESTs as the destinations of this request; if "-r"
##H option is used, cancels previous destination requests.
##H
##H This script updates the transfer request ticket.

BEGIN {
  use strict; use warnings;
  our $me = $0; $me =~ s|.*/||;
  our $home = $0; $home =~ s|/[^/]+$||; $home ||= "."; $home .= "/../../Toolkit/Common";
  unshift(@INC, $home);
}
use UtilsNet;
use File::Path;
use Cwd;

my $now = time();
my $reset = 0;

while (scalar @ARGV)
{
    if ($ARGV[0] eq '-h' || $ARGV[0] eq '--help') {
	&usage();
    } elsif ($ARGV[0] eq '-r') {
	$reset = 1; shift (@ARGV);
    } elsif ($ARGV[0] eq '--') {
	shift (@ARGV); last;
    } elsif ($ARGV[0] =~ '^-') {
	&usage ("$0: unrecognised option $ARGV[0]\n\n");
    } else {
	last;
    }
}

my $request = shift;
defined $request && -d $request or &usage();

-f "$request/Request/Ticket"
    or die "$request: not a transfer request\n";

# Append to the ticket
(open (TICKET, ">> $request/Request/Ticket")
 && print(TICKET "$now CMD TRNEWLOC @{[scalar getpwuid($<)]}\@@{[&getfullhostname()]}\n")
 && (! $reset || print(TICKET "$now CANCEL LOC\n"))
 && (print(TICKET "$now LOC @ARGV\n"))
 && close (TICKET))
    or die "$request: cannot update ticket: $!\n";
