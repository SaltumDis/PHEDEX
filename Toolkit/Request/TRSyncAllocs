#!/usr/bin/env perl

##H Synchronise request subscritions to TMDB allocations.
##H
##H Usage: TRSyncAllocs -db FILE[:SECTION] REQUEST...
##H
##H REQUEST is the request ticket previously created with TRNew.

BEGIN {
  use strict; use warnings; $^W=1;
  our $me = $0; $me =~ s|.*/||;
  our $home = $0; $home =~ s|/[^/]+$||; $home ||= "."; $home .= "/../../Toolkit/Common";
  unshift(@INC, $home);
}

my %args;
use Getopt::Long;
use UtilsHelp;
use UtilsDB;
&GetOptions ("db=s"        => \$args{DBCONFIG},
	     "help|h"      => sub { &usage() });

if (!$args{DBCONFIG})
{
    die "Incorrect parameters, use -h for help.\n";
}

my $dbh = &connectToDatabase (\%args, 0);
foreach my $request (@ARGV)
{
    -f "$request" or die "$request: not a transfer request\n";

    # Find out the dataset names 
    my @destinations = ();
    my @patterns = ();
    open(TICKET, "< $request") or die "Cannot read ticket: $!\n";
    while (<TICKET>)
    {
	if (/^\d+ CANCEL LOC$/) {
	    @destinations = ();
	} elsif (/^\d+ LOC (.*)$/) {
	    push(@destinations, split(/\s+/, $1));
        } elsif (/^\d+ CANCEL DATA$/) {
	    @patterns = ();
	} elsif (/^\d+ DATA XPATS\.[a-z] (.*)$/) {
	    push(@patterns, split(/\s+/, $1));
	}
    }
    close (TICKET) or die "Cannot read ticket: $!\n";

    # Process each pair
    foreach my $dso (@patterns)
    {
	my ($o, $ds) = ($dso =~ /(.*)\/(.*)/);
	foreach my $dest (@destinations)
	{
	    my ($exists) = &dbexec($dbh, qq{
		select count(*) from t_subscription
		where destination = :dest
		  and owner = :o and dataset = :ds},
  		":dest" => $dest, ":o" => $o, ":ds" => $ds)
		->fetchrow();
	    &dbexec ($dbh, qq{
		insert into t_subscription
		(owner, dataset, destination)
		values (:o, :ds, :dest)},
	    	":dest" => $dest, ":o" => $o, ":ds" => $ds)
		if ! $exists;
	}
    }
    $dbh->commit();
}
$dbh->disconnect();
