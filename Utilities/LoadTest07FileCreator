#!/usr/bin/perl
##H
##H    This scrip creates job submision files for LoadTest07 sample production  
##H
##H    Usage:
##H
##H       LoadTest07FileCreator <copy command to MSS> <batch job submit command> <queue type>  \ 
##H       <storage path> <site> [<batch system mail option> <user's email>]
##H
##H       Start it from somewhere you can submit jobs. From NFS or AFS mounted area or a UI. 
##H       
##H       Creates a jobs/ directory and stores all job files in it. Also creates SubmitAllJobs.sh file 
##H       to submit all job files to batch system/grid. Each job file creates file around 2.5 GB, calculates 
##H       a cksum, gives a file size and copies the file to castor. 
##H
##H       File creation is done in two steps. First there is a creation of a seed (23KB) file filled
##H       with random characters. Seed file is then automaticaly copied copied to batch machine 
##H       from your area (or defined in outbox) along with the CreateFile script (created with this script). 
##H       CreateFile script creates the resulting 2.6 GB file which is then copied to castor and removed 
##H       from batch machine.
##H
##H       ./LoadTest07FileCreator rfcp bsub 8nm /castor/cern.ch/cms/store/PhEDEx_LoadTest07 CERN -u user_email
##H
##H       ./LoadTest07FileCreator dccp qsub short /data/store/PhEDEx_LoadTest07 SITE -M user_email
##H
##H       ./LoadTest07FileCreator srmcp test # Creates sample.jdl file. To get queue match list use:
##H       edg-job-list-match sample.jdl
##H
##H       ./LoadTest07FileCreator srmcp edg-job-submit ce102.cern.ch:2119/jobmanager-lcglsf-grid_2nh_cms  \
##H       srm://srm.cern.ch:8443/srm/managerv1?SFN=/castor/cern.ch/cms/store/PhEDEx_LoadTest07 CERN 
##H

if($ARGV[0] && $ARGV[0] ne 'srmcp' && $ARGV[0] ne 'rfcp' && $ARGV[0] ne 'dccp' && $ARGV[0] ne 'cp') 
{die " \n Not tested for this command! \n The <copy command to MSS> not rfcp nor dccp nor srmcp nor cp! \n\n"; }
if($ARGV[1] eq 'test' && $ARGV[0] eq 'srmcp') {
`cat >> sample.jdl << END_OF_DATA
Executable = "some.job"; 

StdOutput = "some.out";
StdError = "some.err";

InputSandbox = {"./some.job"};
OutputSandbox = {"some.out","some.err"};

VirtualOrganisation="cms";
END_OF_DATA`;
`cat >> some.job << END_OF_DATA
#!/bin/bash
srmcp file:///Test srm://test/Test
END_OF_DATA`;
die " \n The sample.jdl and some.job files are created. To get queue match list use: 
edg-job-list-match sample.jdl \n\n";
}
if(!$ARGV[0] || !$ARGV[1]|| !$ARGV[2] || !$ARGV[3] || !$ARGV[4]) {  die " \n Insufficient parameters, use: \n
LoadTest07FileCreator <copy command to MSS> <batch job submit command> <queue type> <storage path> <site>  \\
[<batch system mail option> <user's email>] \n
Examples: \n
./LoadTest07FileCreator rfcp bsub 8nm /castor/cern.ch/cms/store/PhEDEx_LoadTest07 CERN -u user_email

./LoadTest07FileCreator dccp qsub short /data/store/PhEDEx_LoadTest07 SITE -M user_email 

./LoadTest07FileCreator srmcp test \# Creates sample.jdl file. To get queue match list use: 
edg-job-list-match sample.jdl

./LoadTest07FileCreator srmcp edg-job-submit ce102.cern.ch:2119/jobmanager-lcglsf-grid_2nh_cms  \\
srm://srm.cern.ch:8443/srm/managerv1?SFN=/castor/cern.ch/cms/store/PhEDEx_LoadTest07 CERN \n\n";}
#print $ARGV[0]," ",$ARGV[1]," ",$ARGV[2]," ",$ARGV[3]," ",$ARGV[4]" \n";

my $i = 0;

my $command_file = "SubmitAllJobs.sh";
my $command_cksum_file = "GetAllCksums.sh";
my $create_file = "CreateFile";

open DATA, ">>$command_file" or die "can't open $command_file $!";
print DATA 'cd jobs'."\n";
close (DATA);
open DATA, ">>$command_cksum_file" or die "can't open $command_file $!";
print DATA "# Use it only if you don't get output from jobs submited by SubmitAllJobs.sh \n";
print DATA 'cd jobs'."\n";
close (DATA);
print "  Creating seed (23KB) file... this could take a few minutes... "."\n";
`dd if=/dev/random of=seed count=625`;
chop($seed_info = `ls -al seed `);  $seed_infos = [ split m| \s*|, $seed_info]; $seed_size = $$seed_infos[4]; 
open DATA, ">>$create_file" or die "can't open $create_file $!";
print DATA '#!/usr/bin/perl '."\n";
print DATA 'while($i<$ARGV[0]) { '."\n";
print DATA '    `cat seed >> LoadTest07`; '."\n";
print DATA '    $i++;   '."\n";
print DATA '}  '."\n";
close (DATA);
while( $i < 256) {
$hex = sprintf("%0.2X", $i);
my $size = 3*$i+56375;
if($i==1) {print "File with lowest size to be created : "; print $seed_size*$size."\n";}
if($i==255) {print "File with highest size to be created : "; print $seed_size*$size." \n";}
my $data_file = "LoadTest07_".$hex.".job";
open DATA, ">$data_file" or die "can't open $data_file $!";
print DATA '#!/bin/bash'."\n";
if($ARGV[0] ne 'srmcp') {print DATA 'cp '.$ENV{PWD}.'/jobs/seed .'."\n";
			 print DATA 'cp '.$ENV{PWD}.'/jobs/CreateFile .'."\n";
			 print DATA 'export STAGE_HOST=castorcms'."\n";
			 print DATA 'export STAGE_SVCCLASS=default'."\n";
			 print DATA 'export RFIO_USE_CASTOR_V2=yes'."\n";}
print DATA 'chmod a+x CreateFile'."\n";
print DATA './CreateFile '.$size."\n";
if($ARGV[0] eq 'srmcp') { print DATA 'if [ -d /usr/java/j2re-1.4.2_13 ]; then'."\n";
			  print DATA 'export JAVA_HOME=/usr/java/j2re-1.4.2_13'."\n";
			  print DATA 'fi'."\n\n";
			  print DATA $ARGV[0].' -debug=true -x509_user_trusted_certificates=$X509_CERT_DIR file:///`pwd`/LoadTest07 '.$ARGV[3].'/LoadTest07_'.$ARGV[4].'_'.$hex."\n";}
else {print DATA $ARGV[0].' LoadTest07 '.$ARGV[3].'/LoadTest07_'.$ARGV[4].'_'.$hex."\n";}
if($ARGV[0] eq 'srmcp') {print DATA 'cat >> LoadTest07_files_info_'.$hex.' << END_OF_DATA'."\n";}
else {print DATA 'cat >> '.$ENV{PWD}.'/jobs/LoadTest07_files_info_'.$hex.' << END_OF_DATA'."\n";} 
print DATA $hex.','.'` cksum LoadTest07 | sed \'s/[^0-9][^0-9]*/,/\' | sed \'s/LoadTest07//g\'`'."\n";
print DATA 'END_OF_DATA'."\n";
print DATA 'rm -f seed CreateFile LoadTest07'."\n";
close (DATA);
open DATA, ">>$command_file" or die "can't open $command_file $!";
if($ARGV[0] eq 'srmcp') {print DATA $ARGV[1].' -r '.$ARGV[2].' LoadTest07_'.$hex.".jdl\n";}
else {if($ARGV[5] && $ARGV[5]) {print DATA $ARGV[1].' -q '.$ARGV[2].' '.$ARGV[5].' '.$ARGV[6].' LoadTest07_'.$hex.".job\n";}
      if(!$ARGV[5] || !$ARGV[6]) {print DATA $ARGV[1].' -q '.$ARGV[2].' LoadTest07_'.$hex.".job\n";}
 }
close (DATA);
if($ARGV[0] eq 'srmcp') { my $data_jdl_file = "LoadTest07_".$hex.".jdl";
			  open DATA, ">$data_jdl_file" or die "can't open $data_file $!";
			  print DATA 'Executable = "LoadTest07_'.$hex.'.job";'."\n\n\n";
			  print DATA 'StdOutput = "LoadTest07_'.$hex.'.out";'."\n";
			  print DATA 'StdError = "LoadTest07_'.$hex.'.err";'."\n\n";
			  print DATA 'InputSandbox = {"./LoadTest07_'.$hex.'.job","./seed","./CreateFile"};'."\n";
			  print DATA 'OutputSandbox = {"LoadTest07_'.$hex.'.out","LoadTest07_'.$hex.'.err","LoadTest07_files_info_'.$hex.'"};'."\n\n";
			  print DATA 'VirtualOrganisation="cms";'."\n";

			  close (DATA);
		      }
$i++;

if($ARGV[0] ne 'srmcp') {
open DATA, ">>$command_cksum_file" or die "can't open $command_file $!";
if($ARGV[5] && $ARGV[5]) {print DATA $ARGV[1].' -q '.$ARGV[2].' '.$ARGV[5].' '.$ARGV[6].' get_cksum_'.$hex.".job\n";}
if(!$ARGV[5] || !$ARGV[6]) {print DATA $ARGV[1].' -q '.$ARGV[2].' get_cksum_'.$hex.".job\n";}
close (DATA);
    my $cksum_file = "get_cksum_".$hex.".job";
    open DATA, ">>$cksum_file" or die "can't open $command_file $!";
    print DATA '#!/bin/bash'."\n";
    print DATA "echo '#===='"."\n";
    print DATA 'cat >> '.$ENV{PWD}.'/jobs/LoadTest07_files_info_'.$hex.' << END_OF_DATA'."\n";
    print DATA $hex.','.'` rfcat '.$ARGV[3].'/LoadTest07_'.$ARGV[4].'_'.$hex.'| cksum | sed \'s/[^0-9][^0-9]*/,/\' | sed \'s/LoadTest07//g\'`'."\n";
    print DATA 'END_OF_DATA'."\n";
    print DATA "echo '#====='"."\n";
close (DATA);
}
}
open DATA, ">>$command_file" or die "can't open $command_file $!";
print DATA "echo '=========================================='"."\n";
print DATA "echo 'when all files are created do: '"."\n";
if($ARGV[0] eq 'srmcp') { print DATA "echo 'get all LoadTest07_files_info_* files from your output into jobs/ directory and do: '"."\n";}
print DATA "echo '    cat jobs/LoadTest07_files_info_* > LoadTest07_files_info'"."\n";
print DATA "echo 'and copy LoadTest07_files_info file in folder where LoadTest07FileInjector is.'"."\n";
print DATA "echo 'i.e. in SITECONF/".$ARGV[4]."/PhEDEx folder '"."\n";
print DATA "echo '=========================================='"."\n";
close (DATA);
if($ARGV[0] ne 'srmcp') {
    open DATA, ">>$command_cksum_file" or die "can't open $command_file $!";
    print DATA "echo '=========================================='"."\n";
    print DATA "echo 'when all files are created do: '"."\n";
    print DATA "echo '    cat jobs/LoadTest07_files_info_* > LoadTest07_files_info'"."\n";
    print DATA "echo 'and copy LoadTest07_files_info file in folder where LoadTest07FileInjector is.'"."\n";
    print DATA "echo 'i.e. in SITECONF/".$ARGV[4]."/PhEDEx folder '"."\n";
    print DATA "echo '=========================================='"."\n";
}
system 'chmod a+x CreateFile *.job SubmitAllJobs.sh GetAllCksums.sh';
mkdir("jobs", 0755) || die "Cannot mkdir jobs: $!";
system 'mv *.job seed CreateFile jobs/';
if($ARGV[0] eq 'srmcp') {system 'mv *.jdl jobs/';}
