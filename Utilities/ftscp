#!/bin/sh

##H This is a "srmcp"-like script using FTS to transfer files.
##H
##H Usage: ftscp -copyjobfile=FILE [-report=FILE]
##H
##H Takes a list of source/destination file pairs and copies them
##H using FTS.  The files must be given through a "copyjob" file,
##H with one "SOURCE DESTINATION" line per file copy, the names
##H separated with a single space character, and no leading or
##H trailing white space.
##H
##H If the "-report" option is used, the status of each file copy
##H is written in there.  The exit code from the command is zero
##H if all the files have been copied successfuly, otherwise non-
##H zero; the details can be found in the report file.

usage() { grep '^##H' < $0 | sed 's/^\(##H \|##H$\)//'; exit 1; }

# Pick up options
report=/dev/null copyjob=
while [ $# -ge 1 ]; do
  case $1 in
    -copyjobfile=* )
      copyjob="${1#-copyjob=}"
    -report=* )
      report="${1#-report=}"
    -h )
      usage;;
    -* )
      echo "unrecognised option $1" 1>&2; exit 1 ;;
    * )
      break ;;
  esac
done

[ -z "$copyjob" ] || { echo "Missing -copyjobfile, use -h for help." 1>&2; exit 1; }
[ ! -f "$copyjob" ] || { echo "$copyjob: no such file" 1>&2; exit 2; }
[ ! -r "$copyjob" ] || { echo "$copyjob: cannot read" 1>&2; exit 3; }

# http://egee-jra1-dm.web.cern.ch/egee-jra1-dm/transfer/docu1.1.1/fts-cli.pdf
ftsjobid=

# FIXME: signal handling
# trap 1 2 15 's=$?; [ -z "$ftsjobid" ] || glite-transfer-cancel $ftsjobid; exit $s'

# Create a FTS transfer request.
ftsjob=$(glite-transfer-submit -f "$copyjob")

# Poll transfer status, record output into the report
while true; do
  # FIXME: we need to be recording per-file status, not just the job!
  ftsstatus="$(glite-transfer-status "$ftsjob")"
  case $ftstatus in
    Pending )
      # FIXME: Need something smarter here, adaptive sleep based on
      # how much has been done and remains to be done.
      sleep 5 ;;

    Canceled )
      # FIXME: Is it really "Canceled" (sic)?  Handle aborted job.
      FIXME ;;

    FIXME )
      # Job done, record report file, quit
      exitcode=0
      while read src dest; do
	# FIXME: Get the transfer status for this pair
	[ X"$status" != X0 ] && exitcode=10
        echo "$src $dest $status"
      done < "$copyjob" > "$report"
      exit $exitcode
      ;;

    * )
      echo "ftscp: unexpected job status $ftsstatus" 1>&2
      exit 4
      ;;
  done
done
