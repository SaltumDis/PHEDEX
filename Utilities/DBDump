#!/usr/bin/env perl

##H Dump tables from database
##H
##H Usage:
##H   DBDump -db FILE[:SECTION] } TABLE...
##H
##H -db           database connection configuration parameter file
##H TABLE         name of the table to dump

BEGIN { use strict; use warnings; $^W=1;
  my $me = $0; $me =~ s|.*/||;
  my $home = $0; $home =~ s|/[^/]+$||; $home ||= ".";
  unshift(@INC, "$home/../Toolkit/Common"); }

my %args;
use Getopt::Long;
use UtilsHelp;
use UtilsDB;
&GetOptions ("db=s"        => \$args{DBCONFIG},
	     "help|h"      => sub { &usage() });

if (! $args{DBCONFIG})
{
    die "Insufficient parameters, use -h for help.\n";
}

my $dbh = &connectToDatabase (\%args, 0);
foreach my $table (@ARGV)
{
    my $q = &dbexec ($dbh, qq{select * from $table});
    my $nrows = 0;
    while (my $row = $q->fetchrow_hashref())
    {
	print "$table,", ++$nrows;
	foreach my $k (sort keys %$row)
	{
	    my $v = $row->{$k};
	    print defined $v ? ",$k,\"$v\"" : ",$k,";
	}
	print "\n";
    }
}

&disconnectFromDatabase(\%args, $dbh, 1);
